---
title: "Tutorial 2: Anatomical and Diffusion MRI Pipelines"
teaching: 15
exercises: 45
questions:
- "How can I map the structural human brain connectome at multiple scales from MRI?"
objectives:
- Get familiar with a BIDS App
- Use Connectome Mapper 3 to estimate, in the BIDS ecosystem, from raw anatomical and diffusion MRI, brain parcellation at multiple scales and the corresponding structural connectivity matrices, 
keypoints:
- TBC
---

###  Introduction

This tutorial illustrates a step-by-step guide to compute, in the BIDS ecosystem, from raw anatomical and diffusion MRI of the summerschool dataset, brain parcellation at multiple scales and the corresponding structural connectivity matrices, using the Connectome Mapper 3.

> ## Tutorial outline
> - What is Connectome Mapper 3?
> - How to configure Connectome Mapper 3 pipelines with `cmpbidsappmanager`
> - How to run Connectome Mapper 3 pipelines with `cmpbidsappmanager`
> - How to run the Connectome Mapper 3 command line interface
{: .callout}

###  What is Connectome Mapper 3?

[`Connectome Mapper 3 (CMP3)`](https://github.com/connectomicslab/connectomemapper3) is an open-source Python3 image processing pipeline software that implements full anatomical, diffusion and resting-state MRI processing pipelines, from raw Diffusion / T1 / T2 / BOLD data to multi-resolution connection matrices.

CMP3 pipelines use a combination of tools from well-known software packages, including [FSL](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki), [FreeSurfer](https://surfer.nmr.mgh.harvard.edu/fswiki/FreeSurferWiki), [ANTs](http://stnava.github.io/ANTs/), [MRtrix3](http://www.mrtrix.org/), [Dipy](https://nipy.org/dipy/) and [AFNI](https://afni.nimh.nih.gov/), orchestrated by the [Nipype](https://nipype.readthedocs.io/en/latest/) dataflow library. These pipelines were designed to provide the best software implementation for each state of processing, and they can be easily updated as newer and better neuroimaging software become available.

Reproducibility and replicatibility is achieved through the distribution of a BIDSApp, a software container image which takes BIDS datasets as inputs and which provides a frozen environment where versions of all external softwares and libraries are fixed.

Furthermore, CMP3 comes with a Graphical User Interface aka `cmpbidsappmanager`, designed to facilitate the configuration of all pipeline stages, the configuration of the BIDS App run and its execution, and the inspection of the different stage outputs with appropriate viewers.

For convenience for the summer school, CMP3 is installed in a Ubuntu 20.04 virtual machine along with the following viewer:

* `freeview`: Viewer of FreeSurfer tool used to visualize FreeSurfer outputs of the segmentation stages and outputs of the parcellation stage. 

* `mrview`: Viewer of MRtrix3 used to visualize most of the diffusion pipeline outputs such as the preprocessed diffusion data, th estimated noise or the reconstructed fiber orientation distribution function (ODF) image.

* `trackvis`: Viewer to visualize the reconstructed fibers. 

* `fsleyes`: Viewer of FSL used to overlay images to support registration quality assessment and display a number of outputs of the fMRI pipeline

Note that you will need to provide your own license at first use of `trackvis`. Please check [this section](link-to-be-coming) to know more about how to get one. Note also that you will need to provide your own Freesurfer license to use both CMP3 and `freeview`. Please check [this section](link-to-be-coming) to know more about how to get one.

For more documentation, please check the resources below.

> ## Resources
> - **Documentation:** [https://connectome-mapper-3.readthedocs.io](https://connectome-mapper-3.readthedocs.io)
> - **How to use `cmpbidsappmmanager`:** [https://connectome-mapper-3.readthedocs.io/en/latest/bidsappmanager.html](https://connectome-mapper-3.readthedocs.io/en/latest/bidsappmanager.html)
> - **How to use CMP3 BIDS App commandline interface:** [https://connectome-mapper-3.readthedocs.io/en/latest/usage.html](https://connectome-mapper-3.readthedocs.io/en/latest/usage.html)
{: .callout}

### CMP3 pipelines for estimation of brain parcellations and connectomes at multiple scale

As illustrated by the Figure below, which comes directly from CMP3 documentation, CMP3 provides the following pipelines:

*   **Anatomical pipeline** that computes the different cortical parcellations from anatomical MRI data.

*   **Diffusion pipeline** that computes the different structural brain connectivity maps from diffusion MRI data.

*   **fMRI pipeline** that computes the different brain functional connectivity maps based on the Pearson's correlation between time-series of the cortical parcels.

![Image not found](https://connectome-mapper-3.readthedocs.io/en/latest/_images/flowchart_bidsapp.png)

Source: [https://connectome-mapper-3.readthedocs.io/en/latest/\_images/flowchart_bidsapp.png](https://connectome-mapper-3.readthedocs.io/en/latest/_images/flowchart_bidsapp.png)

For the sake of modularity, each of the pipeline is split into multiple stages.

The anatomical pipeline is composed of:

*   **Segmentation stage** that performs brain tissue segmentation and cortical surface reconstruction with the help of FreeSurfer.

*   **Parcellation stage** that performs brain parcellation based on a NativeFreeSurfer / Lausanne2008 / Lausanne2018 parcellation scheme.

The diffusion pipeline consists of:

*   **Preprocessing stage** that can perform denoising, bias field correction, eddy current distorsion and motion correction, and resampling of the diffusion MRI data

*   **Registration stage** that co-registers the anatomical MRI to the diffusion-free B0 image and project the brain parcellations to the (resampled) diffusion MRI space.

*   **Diffusion stage** that performs (1) the reconstruction of the diffusion signal via Tensor or CSD models, and (2) the reconstruction of the fibers (tractography).

*   **Connectome stage** that maps the reconstructed fibers to the different cortical parcels and build a number of different structural brain connectivity maps such as the number of fibers, the fiber density, the mean fiber length, etc...

The fMRI pipeline is composed of:

*   **Preprocessing stage** that can perform despiking, slice-timing, eddy current distorsion, and motion correction

*   **Registration stage** co-registers the anatomical MRI to the mean BOLD image and project the brain parcellations to the mean BOLD space.

*   **fMRI processing stage** that can perform nuisance regression and bandpass filtering.

*   **Connectome stage** that computes (1) the time-serie of each cortical parcels followed by (2) the Pearson's correlation between each cortical parcel time-serie.

In the next exercises, you will learn how to configure the different pipelines and run CMP3 to produce the structural brain connectivity maps that will be used in the next tutorials.


> ## Exercise 1: Use `cmpbidsappmanager` to configure the anatomical and diffusion pipelines (click on the arrow to open)
>
> In this exercise you will work through the configuration of CMP3 pipelines with `cmpbidsappmanager`.  Please follow the following steps:
>
> 1. Open a terminal and launch `cmpbidsappmanager`
> 2. Load the summerschool dataset that in located in `$HOME/Data/ds003505`
> 3. Open the Configurator Window
> 4. Configure the different stages as follows:
>
>    TBC
>
> 5. When you are done, save all configuration files
>
> > ## Solution (click on the arrow to open)
> >
> > We have made the pipeline configuration file solutions available:
> >
> > 1. Download the [Anatomical Pipeline Configuration file]({{site.root}}/data/ref_anatomical_config.json)
> > 2. Download the [Diffusion Pipeline Configuration file]({{site.root}}/data/ref_diffusion_config.json)
> {: .solution}
{: .challenge}

> ## Exercise 2: Use `cmpbidsappmanager` to run the BIDSApp (click on the arrow to open)
>
> In this exercise you will work through the configuration and execution of the BIDSApp of CMP3 with `cmpbidsappmanager`.  Please follow the following steps:
>
> 1. If `cmpbidsappmanager` is not started, launch `cmpbidsappmanager` and load the summerschool dataset as in the previous exercise
> 2. Open the BIDS App Window
> 3. Select to process `sub-01` and control that the configuration files are pointing to  `$HOME/Data/ds003505/code/ref_anatomical_config.json` and `$HOME/Data/ds003505/code/ref_diffusion_config.json`
> 4. Check the run configuration and run the BIDS App
{: .challenge}

> ## Exercise 3: Use `cmpbidsappmanager` to check pipeline outputs with external viewers (click on the arrow to open)
>
> In this exercise you will work through the configuration of CMP3 pipelines with `cmpbidsappmanager`.  Please follow the following steps:
>
> 1. Open a terminal and launch `cmpbidsappmanager`
> 2. Load the summerschool dataset that in located in `$HOME/Data/ds003505`
> 3. Open the Configurator Window
> 4. Configure the different stages as follows:
>
>    TBC
>
> 5. When you are done, save all configuration files
>
> > ## Solution (click on the arrow to open)
> >
> > We have made the pipeline configuration file solutions available:
> >
> > 1. Download the [Anatomical Pipeline Configuration file]({{site.root}}/data/ref_anatomical_config.json)
> > 2. Download the [Diffusion Pipeline Configuration file]({{site.root}}/data/ref_diffusion_config.json)
> {: .solution}
{: .challenge}

> ## Exercise 4: Run directly the BIDSApp commandline interface (click on the arrow to open)
>
> In this exercise you will have to reproduce the execution of the BIDS App via `cmpbidsappmanager` using directly its commandline interface.
>
> Hint: In the last exercise, `cmpbidsappmanager` displayed the generated command in the terminal output when running the BIDS App.
>
> > ## Solution (click on the arrow to open)
> >
> > The command should be:
> >
> > ~~~
> > docker run -it --rm \
> > -v /home/sinergiasummerschool/Data/ds003505:/bids_dir \
> > -v /home/sinergiasummerschool/Data/ds003505/derivatives:/output_dir \
> > -v /home/sinergiasummerschool/Softwares/freesurfer/license.txt:/bids_dir/code/license.txt \
> > -v /home/sinergiasummerschool/Data/ds003505/code/ref_anatomical_config.json:/code/ref_anatomical_config.json \
> > -v /home/sinergiasummerschool/Data/ds003505/code/ref_diffusion_config.json:/code/ref_diffusion_config.json \
> > -u "$(id -u)":"$(id -g)" \
> > sebastientourbier/connectomemapper-bidsapp:v3.0.0-RC4 \  # CMP BIDS App Docker image
> > /bids_dir /output_dir participant --participant_label 01 \  # BIDS App argument sets
> > --anat_pipeline_config /code/ref_anatomical_config.json \
> > --dwi_pipeline_config /code/ref_diffusion_config.json \
> > --fs_license /bids_dir/code/license.txt
> > ~~~
> > {: .language-bash}
> {: .solution}
{: .challenge}